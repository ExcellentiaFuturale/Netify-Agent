# Netify Agent
# Copyright (C) 2016-2018 eGloo, Incorporated
#
# This is free software, licensed under the GNU General Public License v3.

include $(TOPDIR)/rules.mk

PKG_NAME:=@PACKAGE_TARNAME@
PKG_VERSION:=@PACKAGE_VERSION@
PKG_RELEASE:=1
PKG_MAINTAINER:=Darryl Sokoloski <darryl@egloo.ca>
PKG_LICENSE:=GPL-3.0+

PKG_BUILD_PARALLEL:=1
PKG_FIXUP:=autoreconf
PKG_INSTALL:=1

PKG_CONFIG_DEPENDS:=CONFIG_LIBCURL_ZLIB

PKG_SOURCE_PROTO:=git
PKG_SOURCE_URL:=@GIT_SOURCE_URL@
PKG_SOURCE_DATE:=@GIT_LAST_COMMIT_DATE@
PKG_SOURCE_VERSION:=@GIT_LAST_COMMIT_HASH@
PKG_MIRROR_HASH:=whatever

include $(INCLUDE_DIR)/package.mk

define Package/@PACKAGE_TARNAME@
  SECTION:=net
  CATEGORY:=Network
  TITLE:=Netify Agent
  URL:=http://www.netify.ai/
  DEPENDS:=+libcurl +libmnl +libnetfilter-conntrack +libjson-c +libpcap +zlib +libpthread +uclibcxx +libstdcpp
endef

define Package/@PACKAGE_TARNAME@/description
Netify provides visibility into the traffic on your network along with the
option to take an active role (on supported devices) in blocking or shaping
undesirable traffic from recurring on your network.

endef

define Package/@PACKAGE_TARNAME@/conffiles
/etc/@PACKAGE_TARNAME@.conf
endef

COPTS =

TARGET_CFLAGS += -ffunction-sections -fdata-sections
TARGET_CXXFLAGS += -ffunction-sections -fdata-sections
TARGET_LDFLAGS += -Wl,--gc-sections

CONFIGURE_VARS += \
	LIBCURL_CFLAGS="-I $(STAGING_DIR)/usr/include" \
	LIBCURL_LDFLAGS="-L $(STAGING_DIR)/usr/lib" \
	LIBMNL_CFLAGS="-I $(STAGING_DIR)/usr/include" \
	LIBMNL_LDFLAGS="-L $(STAGING_DIR)/usr/lib" \
	LIBNETFILTER_CONNTRACK_CFLAGS="-I $(STAGING_DIR)/usr/include" \
	LIBNETFILTER_CONNTRACK_LDFLAGS="-L $(STAGING_DIR)/usr/lib"

CONFIGURE_ARGS += \
	--sharedstatedir=/var/lib \
	--disable-inotify \
	--disable-ncurses \
	--disable-libtcmalloc \
	--without-systemdsystemunitdir

define Build/Configure
	(cd $(PKG_BUILD_DIR); ./autogen.sh)
	$(call Build/Configure/Default,$CONFIGURE_ARGS)
endef

define Package/@PACKAGE_TARNAME@/install
	$(INSTALL_DIR) $(1)/etc
	$(INSTALL_DATA) $(PKG_BUILD_DIR)/deploy/netifyd.conf $(1)/etc
	$(INSTALL_DIR) $(1)/etc/init.d
	$(INSTALL_BIN) ./files/netifyd.init $(1)/etc/init.d/netifyd
	$(INSTALL_DIR) $(1)/usr/sbin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/src/netifyd $(1)/usr/sbin
	$(INSTALL_DIR) $(1)/etc/netify.d
	$(INSTALL_DATA) $(PKG_BUILD_DIR)/deploy/app-custom-match.conf $(1)/etc/netify.d/netify-sink.conf
	$(INSTALL_DIR) $(1)/usr/libexec/netifyd
	$(INSTALL_DATA) $(PKG_BUILD_DIR)/deploy/functions.sh $(1)/usr/libexec/netifyd
endef

$(eval $(call BuildPackage,@PACKAGE_TARNAME@))
