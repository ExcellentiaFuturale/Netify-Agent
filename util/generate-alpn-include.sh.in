#!@ND_PATH_BASH@

# https://www.iana.org/assignments/tls-extensiontype-values/tls-extensiontype-values.xhtml#alpn-protocol-ids

CSV="alpn-protocol-ids.csv"
URL="https://www.iana.org/assignments/tls-extensiontype-values/${CSV}"

pushd() {
  command pushd "$@" > /dev/null
}

popd() {
  command popd "$@" > /dev/null
}

if [ -x "$(which wget)" ]; then
  pushd "@abs_top_builddir@/doc" || exit $?
  wget -qcN "${URL}" || exit $?
  popd
elif [ -x "$(which curl)" ]; then
  curl -s "${URL}" -z "@abs_top_builddir@/doc/${CSV}" -o "@abs_top_builddir@/doc/${CSV}" || exit $?
fi

if [ ! -f "@abs_top_builddir@/doc/${CSV}" ]; then
  exit 1
fi

echo -n "#define ND_TLS_ALPN_MAX "
egrep -v '(^Proto|Reserved)' "@abs_top_builddir@/doc/${CSV}" |\
    sed \
        -e 's/^.*,["]*0x/0x/g' \
        -e 's/ (.*//g' \
        -e 's/0x[0-9a-fA-F]*/X/g' \
        -e 's/[[:space:]]*//g' | sort | tail -n 1 | wc -c

egrep -v '(^Proto|Reserved)' "@abs_top_builddir@/doc/${CSV}" |\
    sed \
        -e 's/^.*,["]*0x/0x/g' \
        -e 's/(["“]*/\/* /g' \
        -e 's/["”]*).*$/ *\//g' \
        -e 's/ 0x/, 0x/g' \
        -e 's/^/    { { /g' \
        -e 's/$/, 0x00 }, ND_PROTO_UNKNOWN },/g'

echo "{ { 0x64, 0x6F, 0x71 /* doq */, 0x00 }, ND_PROTO_DOQ },"

exit 0
